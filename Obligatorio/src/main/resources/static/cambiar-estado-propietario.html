<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cambiar Estado de Propietario - Administrador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/utilesVista.js"></script>
    <script src="/js/vistaWeb.js"></script>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white"
  >
    <header class="border-b border-white/10 bg-slate-900/60 backdrop-blur">
      <div
        class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between"
      >
        <h1 class="text-xl font-semibold">Cambiar Estado de Propietario</h1>
        <div class="flex items-center gap-3">
          <span id="adminName" class="text-slate-300"></span>
          <a
            href="/dashboard-admin.html"
            class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600 text-sm"
          >
            ‚Üê Volver al Dashboard
          </a>
          <button
            id="logoutBtn"
            class="px-3 py-2 rounded-md bg-red-600 hover:bg-red-500 text-sm"
          >
            Cerrar sesi√≥n
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-6 py-10">
      <!-- Paso 1: Buscar Propietario -->
      <div class="bg-white/5 rounded-2xl border border-white/10 p-6 mb-6">
        <h2 class="text-2xl font-semibold mb-6">üîç Buscar Propietario</h2>

        <div class="flex gap-4 mb-4">
          <div class="flex-1">
            <label class="block text-sm font-medium mb-2"
              >C√©dula del Propietario</label
            >
            <input
              type="text"
              id="cedulaInput"
              placeholder="Ej: 12345678"
              class="w-full px-4 py-2 rounded-md bg-slate-800 border border-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none"
            />
          </div>
          <div class="flex items-end">
            <button
              id="buscarBtn"
              class="px-6 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 font-semibold transition-colors"
            >
              Buscar
            </button>
          </div>
        </div>

        <!-- Resultado de la b√∫squeda -->
        <div
          id="propietarioInfo"
          class="hidden mt-6 bg-slate-800/50 rounded-lg p-4 border border-slate-700"
        >
          <h3 class="text-lg font-semibold mb-3 text-indigo-400">
            üë§ Datos del Propietario
          </h3>
          <div class="space-y-2 text-sm">
            <p>
              <span class="text-slate-400">Nombre Completo:</span>
              <span id="propNombre" class="ml-2 font-medium"></span>
            </p>
            <p>
              <span class="text-slate-400">Estado Actual:</span>
              <span id="propEstadoActual" class="ml-2 font-medium"></span>
            </p>
            <p>
              <span class="text-slate-400">Saldo:</span>
              <span id="propSaldo" class="ml-2 font-medium"></span>
            </p>
          </div>
        </div>
      </div>

      <!-- Paso 2: Seleccionar Nuevo Estado -->
      <div
        id="cambiarEstadoSection"
        class="hidden bg-white/5 rounded-2xl border border-white/10 p-6 mb-6"
      >
        <h2 class="text-2xl font-semibold mb-6">üîÑ Cambiar Estado</h2>

        <div class="mb-6">
          <label class="block text-sm font-medium mb-4"
            >Seleccionar Nuevo Estado</label
          >
          <div id="estadosContainer" class="grid grid-cols-2 gap-4">
            <!-- Los estados se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>

        <button
          id="cambiarEstadoBtn"
          class="w-full px-6 py-3 rounded-md bg-green-600 hover:bg-green-500 font-semibold transition-colors disabled:bg-slate-600 disabled:cursor-not-allowed"
          disabled
        >
          ‚úì Cambiar Estado
        </button>
      </div>

      <!-- Mensaje de estado -->
      <div
        id="messageContainer"
        class="hidden mt-4 p-4 rounded-lg border"
      ></div>
    </main>

    <script>
      // Configurar URLs para observador
      var urlIniciarVista = "/admin/cambiar-estado/vistaConectada";
      var urlCierreVista = "/admin/cambiar-estado/vistaCerrada";

      // Estado de la aplicaci√≥n
      let estados = [];
      let propietarioCedula = "";
      let propietarioData = null;
      let estadoSeleccionado = null;

      // Cargar datos del administrador
      function loadAdmin() {
        const raw = sessionStorage.getItem("admin");
        if (!raw) {
          window.location.href = "/login-admin.html";
          return null;
        }
        try {
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      function setHeader(dto) {
        document.getElementById("adminName").textContent =
          dto?.nombreCompleto || "";
      }

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        const raw = sessionStorage.getItem("admin");
        let data = "";
        try {
          const dto = raw ? JSON.parse(raw) : null;
          if (dto && typeof dto.cedula !== "undefined") {
            data = `cedula=${encodeURIComponent(dto.cedula)}`;
          }
        } catch {}

        fetch("/admin/logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: data,
        }).catch(() => {});

        sessionStorage.removeItem("admin");
        setTimeout(() => {
          window.location.href = "/login-admin.html";
        }, 400);
      });

      // Funci√≥n mostrar_ para recibir estados
      function mostrar_estadosCargados(data) {
        estados = data;
        mostrarEstados();
      }

      // Cargar estados disponibles
      function cargarEstados() {
        submit("/admin/cambiar-estado/estados", "");
      }

      // Mostrar estados como opciones seleccionables
      function mostrarEstados() {
        const container = document.getElementById("estadosContainer");
        if (!estados || estados.length === 0) {
          container.innerHTML =
            '<p class="text-slate-400 text-sm col-span-2">No hay estados disponibles</p>';
          return;
        }

        container.innerHTML = "";
        estados.forEach((estado) => {
          const div = document.createElement("div");
          div.className =
            "bg-slate-800/50 rounded-lg p-4 border border-slate-600 cursor-pointer hover:bg-slate-700/50 hover:border-indigo-500 transition-all";
          div.dataset.estado = estado.nombre;

          // Agregar icono seg√∫n el estado
          let icono = "‚ö™";
          if (estado.nombre === "Habilitado") icono = "‚úÖ";
          else if (estado.nombre === "Penalizado") icono = "‚ö†Ô∏è";
          else if (estado.nombre === "Suspendido") icono = "üö´";
          else if (estado.nombre === "Deshabilitado") icono = "‚ùå";

          div.innerHTML = `
            <div class="flex items-center justify-between">
              <span class="font-medium">${icono} ${estado.nombre}</span>
              <span class="text-indigo-400 text-xl hidden">‚úì</span>
            </div>
          `;

          div.addEventListener("click", () =>
            seleccionarEstado(estado.nombre, div)
          );
          container.appendChild(div);
        });
      }

      // Seleccionar un estado
      function seleccionarEstado(nombreEstado, divElement) {
        estadoSeleccionado = nombreEstado;

        // Remover selecci√≥n de todos
        document.querySelectorAll("#estadosContainer > div").forEach((d) => {
          d.classList.remove("border-indigo-500", "bg-slate-700/50");
          d.classList.add("border-slate-600");
          d.querySelector("span.text-indigo-400").classList.add("hidden");
        });

        // Marcar el seleccionado
        divElement.classList.add("border-indigo-500", "bg-slate-700/50");
        divElement.classList.remove("border-slate-600");
        divElement
          .querySelector("span.text-indigo-400")
          .classList.remove("hidden");

        // Habilitar bot√≥n
        document.getElementById("cambiarEstadoBtn").disabled = false;
      }

      // Funci√≥n mostrar_ para recibir datos del propietario
      function mostrar_propietarioEncontrado(data) {
        propietarioData = data;
        mostrarPropietario(propietarioData);
        document.getElementById("propietarioInfo").classList.remove("hidden");
        document
          .getElementById("cambiarEstadoSection")
          .classList.remove("hidden");
        preseleccionarEstadoActual(propietarioData.estado);
        mostrarMensaje("‚úì Propietario encontrado", "success");
      }

      // Buscar propietario
      document.getElementById("buscarBtn").addEventListener("click", () => {
        const cedula = document.getElementById("cedulaInput").value.trim();
        if (!cedula) {
          mostrarMensaje("Debe ingresar una c√©dula", "error");
          return;
        }
        propietarioCedula = cedula;
        submit(
          "/admin/cambiar-estado/propietario",
          `cedula=${encodeURIComponent(cedula)}`
        );
      });

      // Mostrar informaci√≥n del propietario
      function mostrarPropietario(data) {
        document.getElementById("propNombre").textContent =
          data.nombreCompleto || "-";

        const estadoSpan = document.getElementById("propEstadoActual");
        estadoSpan.textContent = data.estado || "-";

        // Colorear seg√∫n el estado
        if (data.estado === "Deshabilitado") {
          estadoSpan.className = "ml-2 font-medium text-red-400";
        } else if (data.estado === "Suspendido") {
          estadoSpan.className = "ml-2 font-medium text-orange-400";
        } else if (data.estado === "Penalizado") {
          estadoSpan.className = "ml-2 font-medium text-yellow-400";
        } else {
          estadoSpan.className = "ml-2 font-medium text-green-400";
        }

        document.getElementById("propSaldo").textContent =
          "$" + (data.saldoActual || 0);
      }

      // Preseleccionar el estado actual
      function preseleccionarEstadoActual(estadoActual) {
        const divs = document.querySelectorAll("#estadosContainer > div");
        divs.forEach((div) => {
          if (div.dataset.estado === estadoActual) {
            seleccionarEstado(estadoActual, div);
          }
        });
      }

      // Funci√≥n mostrar_ para estado cambiado exitosamente
      function mostrar_estadoCambiado(resultado) {
        mostrarMensaje("‚úÖ Estado cambiado exitosamente", "success");
        // Recargar informaci√≥n del propietario
        setTimeout(() => {
          document.getElementById("buscarBtn").click();
        }, 1000);
      }

      // Funci√≥n mostrar_ para manejar errores de negocio
      function mostrar_error(mensaje) {
        mostrarMensaje("‚ùå " + mensaje, "error");
      }

      // Cambiar estado
      document
        .getElementById("cambiarEstadoBtn")
        .addEventListener("click", () => {
          if (!estadoSeleccionado) {
            mostrarMensaje("Debe seleccionar un estado", "error");
            return;
          }
          const datos = `cedula=${encodeURIComponent(
            propietarioCedula
          )}&nuevoEstado=${encodeURIComponent(estadoSeleccionado)}`;
          submit("/admin/cambiar-estado", datos);
        });

      // Mostrar mensaje
      function mostrarMensaje(texto, tipo) {
        const container = document.getElementById("messageContainer");
        container.className =
          "mt-4 p-4 rounded-lg border " +
          (tipo === "error"
            ? "bg-red-900/20 border-red-500 text-red-300"
            : "bg-green-900/20 border-green-500 text-green-300");
        container.textContent = texto;
        container.classList.remove("hidden");

        setTimeout(() => {
          container.classList.add("hidden");
        }, 5000);
      }

      // Inicializar
      const dto = loadAdmin();
      if (dto) setHeader(dto);
      cargarEstados();

      // Permitir buscar con Enter
      document
        .getElementById("cedulaInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            document.getElementById("buscarBtn").click();
          }
        });
    </script>
  </body>
</html>
